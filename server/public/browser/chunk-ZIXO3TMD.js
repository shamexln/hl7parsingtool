import{A as o,E as p,G as g,L as a,P as f,S as c,Wb as u,Yb as b,j as l,o as s,s as i}from"./chunk-PQW76BEZ.js";var d=class h{constructor(e){this.http=e}_isLoggedIn$=new l(!1);_token$=new l(null);_refreshToken$=new l(null);_refreshing$;get isLoggedIn$(){return this._isLoggedIn$.asObservable()}get isLoggedIn(){return this._isLoggedIn$.value}get token$(){return this._token$.asObservable()}get token(){return this._token$.value}get refreshToken(){return this._refreshToken$.value}setTokens(e,n){this._token$.next(e),this._refreshToken$.next(n),this._isLoggedIn$.next(!!e)}logoutLocal(){this.setTokens(null,null)}setupRequired(){return this.http.get("/api/auth/setup-required").pipe(o(()=>s({setupRequired:!1,status:"error"})))}setupInitial(e,n,t){return this.http.post("/api/auth/setup-initial",{username:e,password:n,confirmPassword:t})}login(e,n){let t={username:e,password:n};return this.http.post("/api/auth/login",t).pipe(i(r=>({access:r?.token??null,refresh:r?.refreshToken??null})),a(({access:r,refresh:k})=>this.setTokens(r,k)),i(({access:r})=>!!r),o(()=>(this.setTokens(null,null),s(!1))))}refreshAccessToken(){let e=this.refreshToken;if(!e)return s(!1);if(this._refreshing$)return this._refreshing$;let n=new u({"X-Refresh-Token":e,"Cache-Control":"no-cache, no-store, must-revalidate",Pragma:"no-cache",Expires:"0"});return this._refreshing$=this.http.get("/api/auth/me",{headers:n}).pipe(i(t=>t?.authenticated&&t?.token?t.token:null),a(t=>{t?this.setTokens(t,e):this.setTokens(null,null)}),i(t=>!!t),o(()=>(this.setTokens(null,null),s(!1))),p(()=>{this._refreshing$=void 0}),g(1)),this._refreshing$}checkSession(){let e=this.refreshToken,n=e?{headers:new u({"X-Refresh-Token":e})}:{};return this.http.get("/api/auth/me",n).pipe(a(t=>{t?.authenticated&&t?.token?this.setTokens(t.token,e??this.refreshToken):t?.authenticated||this.setTokens(null,null)}),i(t=>!!t?.authenticated),o(()=>(this._isLoggedIn$.next(!1),s(!1))))}logout(){let e=this.refreshToken,n=e?{headers:new u({"X-Refresh-Token":e})}:{};return this.http.post("/api/auth/logout",{},n).pipe(o(()=>s(void 0)),a(()=>this.setTokens(null,null)))}static \u0275fac=function(n){return new(n||h)(c(b))};static \u0275prov=f({token:h,factory:h.\u0275fac,providedIn:"root"})};export{d as a};
